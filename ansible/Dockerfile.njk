ARG EXIST_VERSION=6.2.0
ARG BUILD=local

FROM ghcr.io/eeditiones/builder:latest AS builder

ARG APP_NAME=tei-publisher-app
ARG APP_REPO=https://github.com/eeditiones/tei-publisher-app.git
ARG APP_TAG_OR_BRANCH=master

WORKDIR /tmp

# Build the main app configured in the docker-compose.yml
{% for app in publisher.apps %}
RUN  git clone {{app.repo}} \
    && cd {{app.name}} \
    {% if app.tag_or_branch is defined and app.tag_or_branch %}
    && echo Checking out {{app.tag_or_branch}} \
    && git checkout {{app.tag_or_branch}} \
    {% endif %}
    {% if app.local_webcomponents is defined and app.local_webcomponents %}
    && sed -i 's/$config:webcomponents :=.*;/$config:webcomponents := "local";/' modules/config.xqm \
    {% endif %}
    {% if app.prebuild is defined %}
    && {{ app.prebuild }} \
    {% endif %}
    && ant {% if app.local_webcomponents is defined and app.local_webcomponents %}xar-local{% endif %}
    {% raw %}

    {% endraw %}
{% endfor %}
FROM ghcr.io/jinntec/base:${EXIST_VERSION}

ARG APP_NAME=tei-publisher-app
ARG USR=nonroot:nonroot
USER ${USR}
# replace my-edition with name of your app
{% for app in publisher.apps %}
COPY --from=builder --chown=${USR}/tmp/{{app.name}}/build/*.xar /exist/autodeploy/
{% endfor %}

ARG HTTP_PORT=8080
ARG HTTPS_PORT=8443

ARG NER_ENDPOINT=http://localhost:8001
ARG CONTEXT_PATH=auto
ARG PROXY_CACHING=false

ENV JDK_JAVA_OPTIONS="\
    -Dteipublisher.ner-endpoint=${NER_ENDPOINT} \
    -Dteipublisher.context-path=${CONTEXT_PATH} \
    -Dteipublisher.proxy-caching=${PROXY_CACHING}"

# pre-populate the database by launching it once
RUN [ "java", "org.exist.start.Main", "client", "--no-gui",  "-l" ]

EXPOSE ${HTTP_PORT} ${HTTPS_PORT}
